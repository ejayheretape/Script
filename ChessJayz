local Lighting = game:GetService("Lighting")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local pgui = player:WaitForChild("PlayerGui")

if Lighting:FindFirstChild("Atmosphere") then Lighting.Atmosphere:Destroy() end
if Lighting:FindFirstChild("Sky") then Lighting.Sky:Destroy() end

Instance.new("Atmosphere", Lighting)
Lighting.Atmosphere.Density = 0.35
Lighting.Atmosphere.Offset = 0.25
Lighting.Atmosphere.Color = Color3.fromRGB(140,80,255)
Lighting.Atmosphere.Decay = Color3.fromRGB(90,40,180)
Lighting.Atmosphere.Glare = 8
Lighting.Atmosphere.Haze = 4.5

local sky = Instance.new("Sky", Lighting)
sky.SkyboxBk = "rbxassetid://230057997"
sky.SkyboxDn = "rbxassetid://230058030"
sky.SkyboxFt = "rbxassetid://230058062"
sky.SkyboxLf = "rbxassetid://230058085"
sky.SkyboxRt = "rbxassetid://230058110"
sky.SkyboxUp = "rbxassetid://230058136"
sky.StarCount = 6000
sky.CelestialBodiesShown = true
sky.Parent = nil
task.wait()
sky.Parent = Lighting

Lighting.Brightness = 2
Lighting.ClockTime = 14
Lighting.GeographicLatitude = 0
Lighting.GlobalShadows = false
Lighting.Ambient = Color3.fromRGB(100,70,160)
Lighting.OutdoorAmbient = Color3.fromRGB(90,60,150)

Instance.new("BloomEffect", Lighting).Intensity = 0.8; Instance.new("BloomEffect", Lighting).Threshold = 0.9; Instance.new("BloomEffect", Lighting).Size = 48
Instance.new("ColorCorrectionEffect", Lighting).Saturation = 0.5; Instance.new("ColorCorrectionEffect", Lighting).Contrast = 0.3; Instance.new("ColorCorrectionEffect", Lighting).TintColor = Color3.fromRGB(200,120,255)
Instance.new("SunRaysEffect", Lighting).Intensity = 0.2; Instance.new("SunRaysEffect", Lighting).Spread = 0.7

local LoadingScreen = Instance.new("ScreenGui", pgui)
LoadingScreen.Name = "LunarLoading"
LoadingScreen.ResetOnSpawn = false
LoadingScreen.IgnoreGuiInset = true
LoadingScreen.DisplayOrder = 999999999

local Background = Instance.new("Frame", LoadingScreen)
Background.Size = UDim2.new(1,0,1,0)
Background.BackgroundColor3 = Color3.new(0,0,0)

local Title = Instance.new("TextLabel", Background)
Title.Size = UDim2.new(0.9,0,0.2,0)
Title.Position = UDim2.new(0.5,0,0.44,0)
Title.AnchorPoint = Vector2.new(0.5,0.5)
Title.BackgroundTransparency = 1
Title.Text = "LunarScriptz"
Title.Font = Enum.Font.GothamBlack
Title.TextScaled = true
Title.TextTransparency = 1
Title.TextStrokeTransparency = 0.8
Title.TextStrokeColor3 = Color3.fromRGB(140,0,255)

local TitleGradient = Instance.new("UIGradient", Title)
TitleGradient.Color = ColorSequence.new{ColorSequenceKeypoint.new(0, Color3.fromRGB(160,0,255)), ColorSequenceKeypoint.new(0.5, Color3.fromRGB(200,100,255)), ColorSequenceKeypoint.new(1, Color3.new(1,1,1))}
TitleGradient.Rotation = 45

local Credit = Instance.new("TextLabel", Background)
Credit.Size = UDim2.new(0.7,0,0.08,0)
Credit.Position = UDim2.new(0.5,0,0.56,0)
Credit.AnchorPoint = Vector2.new(0.5,0.5)
Credit.BackgroundTransparency = 1
Credit.Text = "made by jayz & cypher"
Credit.Font = Enum.Font.Code
Credit.TextScaled = true
Credit.TextTransparency = 1

local CreditGradient = Instance.new("UIGradient", Credit)
CreditGradient.Color = ColorSequence.new{ColorSequenceKeypoint.new(0, Color3.fromRGB(170,0,255)), ColorSequenceKeypoint.new(1, Color3.fromRGB(220,120,255))}
CreditGradient.Rotation = 45

TweenService:Create(Background, TweenInfo.new(1.2), {BackgroundTransparency = 0}):Play()
TweenService:Create(Title, TweenInfo.new(1.8), {TextTransparency = 0}):Play()
TweenService:Create(Credit, TweenInfo.new(2.2), {TextTransparency = 0}):Play()

task.wait(2.8)
TweenService:Create(Background, TweenInfo.new(5, Enum.EasingStyle.Sine), {BackgroundTransparency = 1}):Play()
TweenService:Create(Title, TweenInfo.new(5, Enum.EasingStyle.Sine), {TextTransparency = 1}):Play()
TweenService:Create(Credit, TweenInfo.new(5, Enum.EasingStyle.Sine), {TextTransparency = 1}):Play()

task.wait(5.1)
LoadingScreen:Destroy()

local gui = Instance.new("ScreenGui", pgui)
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0,200,0,340)
frame.Position = UDim2.new(0.7,0,0.2,0)
frame.BackgroundColor3 = Color3.fromRGB(15,15,25)
frame.Active = true
frame.Draggable = true

local corner = Instance.new("UICorner", frame)
corner.CornerRadius = UDim.new(0,12)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,-20,0,24)
title.Position = UDim2.new(0,10,0,8)
title.Text = "LUNAR CHESS"
title.TextColor3 = Color3.fromRGB(0,200,255)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextScaled = true

local engLabel = Instance.new("TextLabel", frame)
engLabel.Size = UDim2.new(1,-20,0,16)
engLabel.Position = UDim2.new(0,10,0,36)
engLabel.Text = "Engine"
engLabel.TextColor3 = Color3.fromRGB(180,220,255)
engLabel.BackgroundTransparency = 1
engLabel.Font = Enum.Font.Gotham
engLabel.TextScaled = true

local engDrop = Instance.new("TextButton", frame)
engDrop.Size = UDim2.new(1,-20,0,28)
engDrop.Position = UDim2.new(0,10,0,56)
engDrop.Text = "Blatant"
engDrop.TextColor3 = Color3.new(1,1,1)
engDrop.Font = Enum.Font.Gotham
engDrop.TextScaled = true
engDrop.BackgroundColor3 = Color3.fromRGB(30,35,50)

local engFrame = Instance.new("Frame", frame)
engFrame.AnchorPoint = Vector2.new(0,1)
engFrame.Position = UDim2.new(0,10,0,56)
engFrame.Size = UDim2.new(1,-20,0,0)
engFrame.BackgroundTransparency = 1
engFrame.ClipsDescendants = true

local engLayout = Instance.new("UIListLayout", engFrame)
engLayout.SortOrder = Enum.SortOrder.LayoutOrder

local modeLabel = Instance.new("TextLabel", frame)
modeLabel.Size = UDim2.new(1,-20,0,16)
modeLabel.Position = UDim2.new(0,10,0,88)
modeLabel.Text = "Match Mode"
modeLabel.TextColor3 = Color3.fromRGB(180,220,255)
modeLabel.BackgroundTransparency = 1
modeLabel.Font = Enum.Font.Gotham
modeLabel.TextScaled = true

local modeDrop = Instance.new("TextButton", frame)
modeDrop.Size = UDim2.new(1,-20,0,28)
modeDrop.Position = UDim2.new(0,10,0,108)
modeDrop.Text = "Blitz"
modeDrop.TextColor3 = Color3.new(1,1,1)
modeDrop.Font = Enum.Font.Gotham
modeDrop.TextScaled = true
modeDrop.BackgroundColor3 = Color3.fromRGB(30,35,50)

local modeFrame = Instance.new("Frame", frame)
modeFrame.AnchorPoint = Vector2.new(0,1)
modeFrame.Position = UDim2.new(0,10,0,108)
modeFrame.Size = UDim2.new(1,-20,0,0)
modeFrame.BackgroundTransparency = 1
modeFrame.ClipsDescendants = true

local delayLabel = Instance.new("TextLabel", frame)
delayLabel.Size = UDim2.new(1,-20,0,16)
delayLabel.Position = UDim2.new(0,10,0,140)
delayLabel.Text = "Move Delay: 0s"
delayLabel.TextColor3 = Color3.fromRGB(180,220,255)
delayLabel.BackgroundTransparency = 1
delayLabel.Font = Enum.Font.Gotham
delayLabel.TextScaled = true

local delayBox = Instance.new("TextBox", frame)
delayBox.Size = UDim2.new(1,-20,0,28)
delayBox.Position = UDim2.new(0,10,0,160)
delayBox.Text = "0"
delayBox.TextColor3 = Color3.new(1,1,1)
delayBox.Font = Enum.Font.Gotham
delayBox.TextScaled = true
delayBox.BackgroundColor3 = Color3.fromRGB(30,35,50)

local playBtn = Instance.new("TextButton", frame)
playBtn.Size = UDim2.new(1,-20,0,32)
playBtn.Position = UDim2.new(0,10,0,196)
playBtn.Text = "Play Best Move"
playBtn.TextColor3 = Color3.new(1,1,1)
playBtn.Font = Enum.Font.GothamBold
playBtn.TextScaled = true
playBtn.BackgroundColor3 = Color3.fromRGB(30,35,50)

local autoPlayBtn = Instance.new("TextButton", frame)
autoPlayBtn.Size = UDim2.new(1,-20,0,32)
autoPlayBtn.Position = UDim2.new(0,10,0,232)
autoPlayBtn.Text = "Auto Play: OFF"
autoPlayBtn.TextColor3 = Color3.new(1,1,1)
autoPlayBtn.Font = Enum.Font.GothamBold
autoPlayBtn.TextScaled = true
autoPlayBtn.BackgroundColor3 = Color3.fromRGB(30,35,50)

local autoMatchBtn = Instance.new("TextButton", frame)
autoMatchBtn.Size = UDim2.new(1,-20,0,32)
autoMatchBtn.Position = UDim2.new(0,10,0,268)
autoMatchBtn.Text = "Auto Match: OFF"
autoMatchBtn.TextColor3 = Color3.new(1,1,1)
autoMatchBtn.Font = Enum.Font.GothamBold
autoMatchBtn.TextScaled = true
autoMatchBtn.BackgroundColor3 = Color3.fromRGB(30,35,50)

local analyzerBtn = Instance.new("TextButton", frame)
analyzerBtn.Size = UDim2.new(1,-20,0,32)
analyzerBtn.Position = UDim2.new(0,10,0,304)
analyzerBtn.Text = "Run Analyzer"
analyzerBtn.TextColor3 = Color3.new(1,1,1)
analyzerBtn.Font = Enum.Font.GothamBold
analyzerBtn.TextScaled = true
analyzerBtn.BackgroundColor3 = Color3.fromRGB(30,35,50)

local toggle = Instance.new("TextButton", gui)
toggle.Size = UDim2.new(0,36,0,36)
toggle.Position = UDim2.new(1,6,0,-6)
toggle.Text = "X"
toggle.BackgroundColor3 = Color3.fromRGB(220,20,60)
toggle.TextColor3 = Color3.new(1,1,1)
toggle.Font = Enum.Font.GothamBold
toggle.TextScaled = true

local gradients = {}

local function addGradient(obj)
    local g = Instance.new("UIGradient", obj)
    g.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0,120,255)),
        ColorSequenceKeypoint.new(1, Color3.new(0,0,0))
    }
    table.insert(gradients, g)
end

local function addStroke(obj, thickness)
    local s = Instance.new("UIStroke", obj)
    s.Thickness = thickness or 1.2
    s.Color = Color3.fromRGB(0,200,255)
end

addGradient(frame)
addStroke(frame, 2.2)
addStroke(toggle, 1.5)

for _, v in {engDrop, modeDrop, delayBox, playBtn, autoPlayBtn, autoMatchBtn, analyzerBtn} do
    addGradient(v)
    addStroke(v)
end

local angle = 0
RunService.Heartbeat:Connect(function(dt)
    angle = (angle + dt * 80) % 360
    for _, g in gradients do
        if g and g.Parent then
            g.Rotation = angle
        end
    end
end)

local function updateToggle()
    toggle.Position = UDim2.fromOffset(frame.AbsolutePosition.X + frame.AbsoluteSize.X - 30, frame.AbsolutePosition.Y - 36)
end
RunService.Heartbeat:Connect(updateToggle)
updateToggle()

local open = true
toggle.MouseButton1Click:Connect(function()
    open = not open
    frame.Visible = open
    toggle.Text = open and "X" or "Open"
end)

getgenv().__CH_DATA = getgenv().__CH_DATA or {
    engines = {"Blatant","HumanEngine","Stockfish","Lc0","Torch","Dx100","KnightX","HyperX","Br1lliance","Undefeated","WurstEngine","Axizion","Zxero"},
    config = {engine = "Blatant", autoPlay = false, autoMatch = false, autoMatchMode = "Blitz", moveDelay = 0},
    recentPositions = {}
}

local ENGINES = {
    Blatant = {depth=2,  variants=1,  elo=1900},
    HumanEngine = {depth=4,  variants=1,  elo=2430},
    Stockfish = {depth=22, variants=5,  elo=3550},
    Lc0 = {depth=18, variants=5,  elo=3150},
    Torch = {depth=20, variants=5,  elo=3400},
    Dx100 = {depth=24, variants=4,  elo=3750},
    KnightX = {depth=26, variants=8,  elo=4050},
    HyperX = {depth=28, variants=7,  elo=4250},
    Br1lliance = {depth=30, variants=12, elo=5220},
    Undefeated = {depth=32, variants=14, elo=6850},
    WurstEngine = {depth=34, variants=8,  elo=6855},
    Axizion = {depth=36, variants=9,  elo=6880},
    Zxero = {depth=42, variants=12, elo=7300}
}

for _, engine in getgenv().__CH_DATA.engines do
    local btn = Instance.new("TextButton", engFrame)
    btn.Size = UDim2.new(1,0,0,22)
    btn.Text = engine.." ("..ENGINES[engine].elo.." ELO)"
    btn.BackgroundColor3 = Color3.fromRGB(25,30,45)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.Gotham
    btn.TextScaled = true
    addGradient(btn)
    addStroke(btn)
    btn.MouseButton1Click:Connect(function()
        getgenv().__CH_DATA.config.engine = engine
        engDrop.Text = engine
        engFrame:TweenSize(UDim2.new(1,-20,0,0), "Out", "Quad", 0.2, true)
    end)
end

engDrop.MouseButton1Click:Connect(function()
    local h = engFrame.Size.Y.Offset == 0 and (#getgenv().__CH_DATA.engines * 22) or 0
    engFrame:TweenSize(UDim2.new(1,-20,0,h), "Out", "Quad", 0.2, true)
end)

local modes = {"Bullet","Blitz","Rapid","Random"}
for _, mode in modes do
    local btn = Instance.new("TextButton", modeFrame)
    btn.Size = UDim2.new(1,0,0,22)
    btn.Text = mode
    btn.BackgroundColor3 = Color3.fromRGB(25,30,45)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.Gotham
    btn.TextScaled = true
    addGradient(btn)
    addStroke(btn)
    btn.MouseButton1Click:Connect(function()
        getgenv().__CH_DATA.config.autoMatchMode = mode
        modeDrop.Text = mode
        modeFrame:TweenSize(UDim2.new(1,-20,0,0), "Out", "Quad", 0.2, true)
    end)
end

modeDrop.MouseButton1Click:Connect(function()
    local h = modeFrame.Size.Y.Offset == 0 and (#modes * 22) or 0
    modeFrame:TweenSize(UDim2.new(1,-20,0,h), "Out", "Quad", 0.2, true)
end)

delayBox.FocusLost:Connect(function(enter)
    if enter then
        local num = tonumber(delayBox.Text)
        if num and num >= 0 then
            getgenv().__CH_DATA.config.moveDelay = num
            delayLabel.Text = "Move Delay: "..num.."s"
        else
            delayBox.Text = tostring(getgenv().__CH_DATA.config.moveDelay)
        end
    end
end)

local function queryEngine(fen, engine)
    local cfg = ENGINES[engine] or ENGINES.Stockfish
    local body = HttpService:JSONEncode({
        fen = fen,
        depth = math.min(cfg.depth, 18),
        variants = math.min(cfg.variants, 5)
    })
    local req = syn and syn.request or request or http_request or http.request
    local res

    if req then
        local success, response = pcall(req, {
            Url = "https://chess-api.com/v1",
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = body
        })
        if success and response and response.StatusCode == 200 then
            res = response
        end
    end

    if not res and HttpService.HttpEnabled then
        local success, response = pcall(HttpService.PostAsync, HttpService, "https://chess-api.com/v1", body, Enum.HttpContentType.ApplicationJson)
        if success then res = {Body = response, StatusCode = 200} end
    end

    if not res or not res.Body then return end
    local success, data = pcall(HttpService.JSONDecode, HttpService, res.Body)
    if not success or not data then return end

    local move = data.recommendations and data.recommendations[1] or data
    if move and move.from and move.to then
        return move.from, move.to
    end
end

local function fetchFEN()
    local attempts = 12
    local ev = ReplicatedStorage:FindFirstChild("InternalClientEvents")
    if ev then
        local ok, active = pcall(ev.GetActiveTableset.Invoke, ev.GetActiveTableset)
        if ok and active then
            for i = 1, attempts do
                local fen = active:FindFirstChild("FEN")
                if fen and fen.Value ~= "" then return fen.Value end
                task.wait(0.08)
            end
        end
    end

    for i = 1, attempts do
        for _, v in workspace:GetChildren() do
            if v.Name == "ChessTableset" and (v.WhitePlayer.Value == player.Name or v.BlackPlayer.Value == player.Name) then
                if v.FEN and v.FEN.Value ~= "" then return v.FEN.Value end
            end
        end
        task.wait(0.08)
    end

    for _, v in workspace:GetDescendants() do
        if v:IsA("StringValue") and v.Name == "FEN" and v.Value ~= "" then
            return v.Value
        end
    end
end

local function getBestMove()
    local fen = fetchFEN()
    if not fen then return end
    task.wait(0.3)
    return queryEngine(fen, getgenv().__CH_DATA.config.engine)
end

local function playMove()
    local from, to = getBestMove()
    if from and to then
        local chess = ReplicatedStorage:FindFirstChild("Chess")
        if chess then
            pcall(chess.SubmitMove.InvokeServer, chess.SubmitMove, from..to)
        end
    end
end

playBtn.MouseButton1Click:Connect(playMove)

local autoPlayRunning = false
autoPlayBtn.MouseButton1Click:Connect(function()
    getgenv().__CH_DATA.config.autoPlay = not getgenv().__CH_DATA.config.autoPlay
    autoPlayBtn.Text = "Auto Play: "..(getgenv().__CH_DATA.config.autoPlay and "ON" or "OFF")
    autoPlayBtn.BackgroundColor3 = getgenv().__CH_DATA.config.autoPlay and Color3.fromRGB(0,140,0) or Color3.fromRGB(30,35,50)
    if getgenv().__CH_DATA.config.autoPlay and not autoPlayRunning then
        autoPlayRunning = true
        task.spawn(function()
            while getgenv().__CH_DATA.config.autoPlay and autoPlayRunning do
                if fetchFEN() then
                    playMove()
                    task.wait(getgenv().__CH_DATA.config.moveDelay)
                else
                    task.wait(1)
                end
            end
            autoPlayRunning = false
        end)
    else
        autoPlayRunning = false
    end
end)

local autoMatchRunning = false
autoMatchBtn.MouseButton1Click:Connect(function()
    getgenv().__CH_DATA.config.autoMatch = not getgenv().__CH_DATA.config.autoMatch
    autoMatchBtn.Text = "Auto Match: "..(getgenv().__CH_DATA.config.autoMatch and "ON" or "OFF")
    autoMatchBtn.BackgroundColor3 = getgenv().__CH_DATA.config.autoMatch and Color3.fromRGB(0,140,0) or Color3.fromRGB(30,35,50)
    if getgenv().__CH_DATA.config.autoMatch and not autoMatchRunning then
        autoMatchRunning = true
        task.spawn(function()
            while getgenv().__CH_DATA.config.autoMatch and autoMatchRunning do
                if not fetchFEN() then
                    local ev = ReplicatedStorage:FindFirstChild("InternalClientEvents")
                    if ev then
                        local start = ev:FindFirstChild("StartRankedMatch") or ev:FindFirstChild("StartMatch")
                        if start then
                            local wiz = pgui:FindFirstChild("MatchWizard")
                            if wiz then
                                local mode = wiz:FindFirstChild("ChooseMode")
                                if mode then
                                    if mode:FindFirstChild("IsRated") then mode.IsRated.Value = true end
                                    if mode:FindFirstChild("Mode") then mode.Mode.Value = getgenv().__CH_DATA.config.autoMatchMode end
                                end
                            end
                            pcall(start.Fire, start, {ranked = true})
                        end
                    end
                    repeat task.wait(3) until fetchFEN()
                end
                task.wait(2)
            end
            autoMatchRunning = false
        end)
    else
        autoMatchRunning = false
    end
end)

local analyzing = false
analyzerBtn.MouseButton1Click:Connect(function()
    if analyzing then return end
    analyzing = true
    analyzerBtn.Text = "Cooldown (30s)"
    analyzerBtn.BackgroundColor3 = Color3.fromRGB(80,80,80)
    pcall(loadstring, game:HttpGet("https://codeberg.org/CypherIsGoated/ChesClub/raw/branch/main/C-Analyzer.lua"))
    task.spawn(function()
        for i = 30, 1, -1 do
            analyzerBtn.Text = "Cooldown ("..i.."s)"
            task.wait(1)
        end
        analyzerBtn.Text = "Run Analyzer"
        analyzerBtn.BackgroundColor3 = Color3.fromRGB(30,35,50)
        analyzing = false
    end)
end)
